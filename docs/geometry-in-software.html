<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">

  <link rel="canonical" href="/geometry-in-software" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="My slightly edited posts from a thread originally discussed on the Beautiful Software seminar forum in November 2020, as. I was in the middle of reading book 2:">

  <meta property="og:site_name" content="Notes on The Nature of Order">

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">

  <link rel="stylesheet" href="/styles.css">

  
  <meta property="og:description" content="My slightly edited posts from a thread originally discussed on the Beautiful Software seminar forum in November 2020, as. I was in the middle of reading book 2:"/>
  

  
  <meta property="og:title" content="Geometry in software">
  <meta property="og:type" content="article">
  

  
  <meta property="article:published_time" content="2021-01-16T11:03:07+00:00">
  <meta property="article:author" content="/">
  

  <meta property="og:url" content="/geometry-in-software" />

  

  <title>
    
      Geometry in software &mdash; Notes on The Nature of Order
    
  </title>
</head>

  <body>
    <nav><div>
    <a class="internal-link" href="/"><b>Notes on The Nature of Order</b></a>
</div>
</nav>
    <div class="wrapper">
      <main><article>
  <div>
    <h1>Geometry in software</h1>
    <time datetime="2021-01-16T11:02:37+00:00">
      Last updated on January 16, 2021
      
    </time>
  </div>

  <div id="notes-entry-container">
    <content>
      <p><em>My slightly edited posts from a thread originally discussed on the Beautiful Software seminar forum in November 2020, as. I was in the middle of reading book 2:</em></p>

<p>Alexander is mostly concerned about the <strong>arrangement of matter in space</strong>. This means looking at <strong>geometry</strong> makes total sense.</p>

<p>Software, however, is made of bits, not atoms. It doesn’t directly manifest in physical space, only indirectly through its user interface. And the laws (of physics) that apply to atoms, do not necessarily apply to bits.</p>

<p>Because of that, it is unclear to me how the fifteen properties can apply to the structure of software programs. (To be fair, nobody said that they should; I still want them to.)</p>

<p>I can see how to apply them to <strong>user interfaces</strong>, which have a geometric representation in physical space (sort of), even though user interfaces frequently go slightly beyond what is governed by laws of physics in the real world. For instance, think of scrolling through a long list or a long article that wouldn’t likely exist with the same dimensions in the physical environment, or views that effortlessly change their size and shape, which couldn’t really happen with actual matter in space.</p>

<p>I still fundamentally believe that there must be some equivalent of the fifteen properties for <strong>software programs</strong>. Programs certainly have structure, but it is structure of a different, more flexible kind, which is mostly unaffected by physical forces and processes in the real world.</p>

<p>Which all leads me to the now obvious question: what would these properties be and what exactly would they be based on?</p>

<hr />

<blockquote>
  <p>In short, I believe there is not that much of a difference between UI and code. Everything on screen is a symbolic representation of bits.</p>
</blockquote>

<p>Hmm… I disagree, but need to think about this more. Code seems to me even more abstract, or better: less rooted in physicality and therefore geometry, than a (visual) user interface does. That’s also why I believe that (simulated) physicality in modern user interfaces has a big future in touchscreens with haptic feedback and direct manipulation of virtual objects that “feels” like moving them around as if they were physical, and have a certain weight, for instance.</p>

<blockquote>
  <p>As we form memories and learn things we are building “structures” in our minds about the world around us that exhibit those properties.</p>
</blockquote>

<p>I suspect — but that is certainly something we haven’t properly figured out yet — that it is somewhat more the other way around: the properties are manifestations of living process in the world, and we are tuned to perceive them as something more special than random arrangements of matter, or purposefully but artificially arranged matter.</p>

<p>There is a famous older paper <a href="https://www.cs.brandeis.edu/~cs146a/handouts/papers/simon-complexity.pdf">The Architecture of Complexity</a> that talks about how there are hierarchies in nature everywhere and somewhat leaves us with the question in the end, if that is because hierarchies are a fundamental building block of how nature and the universe work, or if it’s just our perception and cognition that is tuned to that particular kind of pattern. The answer is likely that it is a little bit of both, but it’s good to be aware that there are these two perspectives.</p>

<p>I think something similar is going on here with the fifteen properties. They are perceivable artifacts of living structure and surely have their origin in the fundamental ways the universe works, but then we can only perceive them in certain ways that have much more to do with how our brain works and what specific patterns we are evolved to detect.</p>

<p>Cognitive science makes a strong connection between bodily experience — how it feels when we move and interact in our physical environment — and basic patterns in the brain (I’m sure I dropped “kinesthetic image schemas” somewhere already) that seem to be fundamental low-level building blocks of how we make sense of the world. They particularly manifest in language, which is pretty much the best window we have into how our brains work across cultures.</p>

<p>Well, I can go on and on about that, but in this thread I was actually more interested in the physicality of code (and perhaps user interfaces, too). And it seems to me that it’s not that simple that the fifteen properties apply in almost the same way, as most of the substrate — laws of physics, how matter behaves — is taken away from the way we organize mostly abstract concepts and symbols.</p>

<hr />

<p>UI and code are somewhat different. Now that I’ve read some more, I’d actually refer to Alexander and say UI is more like a descriptive (declarative?) manifestation while (imperative) code is more like a generative manifestation…? UI also mostly visualizes runtime state while program code generally doesn’t include runtime state, so they can’t be exactly equivalent.</p>

<p>In the physical environment, the 15 properties manifest in different ways, different materials, even somewhat different arrangements. But they have a manifestation in a substrate that allows us to perceive them geometrically.</p>

<p>What’s the actual substrate in programming? What would allow us to perceive the 15 properties in code? The arrangement of machine instructions? The symbols? Their semantics? Something else?</p>

<p>Sure, we could express everything formally in lambda calculus or some combinatory logic and transform any kind of programming language back and forth between them and into one another (which sounds more trivial than it is ;-) — but these are isomorphisms and structurally identical from a mathematical perspective.</p>

<p>If I understand Alexander correctly, the fifteen properties are “structure-preserving” in the wholeness sense, but not in the mathematical sense. The beginning and end state of such a transformation are not “equivalent up to isomorphism” as they are not bijective because they add and change centers. But that’s somewhat unclear to me too, and I hadn’t intended to tackle the formal questions about Alexander’s work (yet?). But maybe that’s necessary to define the fifteen transformations for code?</p>

<p>I was hoping for a more practical and pragmatic way of perceiving the 15 properties in code and applying the 15 transformations to code — maybe getting more specific would help… something like: what would the GRADIENT transformation look like for a computer program? I have no idea, because I don’t know how the gradient would manifest so I can perceive it… if that makes any sense?</p>

<hr />

<p>Yes, we can take all the software things and represent them visually somehow, and then we have something geometrical to apply all the properties to. But when we make that whole or beautiful in the Alexandrian sense, we only did that for that particular representation. In my mind, that does not necessarily mean that the actual software is now more beautiful, just that particular representation of it.</p>

<p>So some things go all the way through to whatever form software has (or is this just another representation?), which could mean that perhaps some of the properties do affect the form, not just the representation. Or maybe (and perhaps likely?) it’s not property specific, but it’s the fact that the properties are all based on something more generic, abstract, that is the basis of all this.</p>

<p>With matter in space, however, I argue that the arrangement of matter in space is not just a representation. It’s a thing where all the laws of physics apply. And it seems that at least some of the properties and their occurrence in nature are tied to exactly that fact.</p>

<p>The way I make sense of this currently is that I imagine looking at a spectrum:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[atoms] –––––––– [bits] –––– [math]
</code></pre></div></div>

<p>The world of atoms with all its complex processes based on physics and all the sciences that build on top of it is on the left.
The world of math is on the right. Laws of physics don’t matter here. It’s all formal. It’s all constructed. It’s pure model.
The world of bits is somewhere in between, and I think it’s a little closer to math. There are a few things, mostly related to data and state, that still have some of the properties that physical things have — they can have “size” and “weight” and use energy and there are certain limitations in play — but it’s only a fraction of the complexity atoms in the physical world have.</p>

<p>While I neither know how useful this perspective is, nor how that would actually work out in detail, it does give me hope that the world of bits is orders of magnitude simpler than the world of atoms. And therefore I can imagine an even simpler set of properties to exist which describes these effects that we perceive as complexity. And it might even be easier to close the gap to the formal world of math and define them precisely, without having to figure out some unanswered questions in quantum physics first.</p>

<hr />

<p>It appears to me that what Alexander tries to teach us with the unfolding process is that there is complexity in the form of relations between centers — everything is connected to everything else — and we need to embrace it, and the way we can still create beautiful stuff is by finding a good sequence that allows us to focus on one thing at a time in the right order to build that web of connections properly. But it’s never about somehow minimizing the number of connections; it’s more like embracing them because they have to exist for it to become coherent and whole.</p>

<p>In software we seemed to have found a different strategy to deal with complexity: we just compartmentalize everything into little isolated decoupled components. That way we never have to look at a whole and can just focus on small things. But perhaps that’s why we end up with less cohesive solutions? This is equivalent to the kind of modular architecture that Alexander criticizes in his domain.</p>

<p>It seems that Alexander found a connection between how we perceive complexity and what the nature of complexity is. This is synthesizing physical, geometric/formal, and cognitive aspects of our existence, which Alexander clearly saw, at least intuitively, while the rest of the world is usually stuck within just one of these modes.</p>

<hr />

<p>Thinking about this more:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[atoms] –––––––– [bits] –––– [math]
</code></pre></div></div>

<p>It’s probably more like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[atoms] –––––––– [UI] ——— [code] ––– [math]
</code></pre></div></div>

<p>In UI position has meaning, and things have a size. There’s also a notion of running out of space, although it’s less of a constraint as it is in the physical world. For instance, we can have arbitrary sizes by using scrolling, and it only gets annoying when scrolling far takes too long. In the real world we would run out of material or the stability of the material would no longer hold, if a physical structure becomes too large.</p>

<p>Code, then, is even further to the right because it has even fewer constraints acting on it. We can describe things with it (objects), which have certain relationships (properties), but these all do not exist spatially, they don’t have a position, or a size, etc. — unless we want to represent them visually and give them arbitrary positions and sizes, etc.</p>

<p>It seems this continuum from left to right is about removing or ignoring certain constraints that act on the elements under consideration. The further you move to the right, the fewer constraints, or rules, are in effect. Until you end up with simple mathematical (algebraic?) structures on the right.</p>

<p>Partially inspired by this tweet and thread: <a href="https://twitter.com/prathyvsh/status/1332740035410419713?s=21">https://twitter.com/prathyvsh/status/1332740035410419713?s=21</a></p>

    </content>

    <side style="font-size: 0.9em">
      <h3 style="margin-bottom: 1em">Notes mentioning this note</h3>
      

      <div style="font-size: 0.9em">
        <p>
          There are no notes linking to this note.
        </p>
      </div>
      
    </side>
  </div>
</article>

<hr>

<p>Here are all the notes in this garden, along with their links, visualized as a graph.</p>

<style>
  .links line {
    stroke: #ccc;
    opacity: 0.5;
  }

  .nodes circle {
    cursor: pointer;
    fill: #8b88e6;
    transition: all 0.15s ease-out;
  }

  .text text {
    cursor: pointer;
    fill: #333;
    text-shadow: -1px -1px 0 #fafafabb, 1px -1px 0 #fafafabb, -1px 1px 0 #fafafabb, 1px 1px 0 #fafafabb;
  }

  .nodes [active],
  .text [active] {
    cursor: pointer;
    fill: black;
  }

  .inactive {
    opacity: 0.1;
    transition: all 0.15s ease-out;
  }

  #graph-wrapper {
    background: #fcfcfc;
    border-radius: 4px;
    height: auto;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"
  integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg=="
  crossorigin="anonymous"></script>

<div id="graph-wrapper">
  <script>
    const MINIMAL_NODE_SIZE = 8;
    const MAX_NODE_SIZE = 12;
    const ACTIVE_RADIUS_FACTOR = 1.5;
    const STROKE = 1;
    const FONT_SIZE = 16;
    const TICKS = 200;
    const FONT_BASELINE = 40;
    const MAX_LABEL_LENGTH = 50;

    const graphData = {"edges":[{"source":"394118713153500426474532463774188","target":"323352844319592415464693835620702358430418676836371564591063739297002084055993596066"},{"source":"64028557324129785503","target":"64028557324129785503"},{"source":"23775038621120774401398070950256476818110844422636","target":"64028557324129785503"},{"source":"205086215272400159040928900","target":"64028557324129785503"},{"source":"64028557324129785503","target":"23775038621120774401398070950256476818110844422636"},{"source":"205086215272400159040928900","target":"23775038621120774401398070950256476818110844422636"},{"source":"30704","target":"102978783333107716768322"},{"source":"138015836477012538048578345382051","target":"769888470198844466060018847331908530558873763"},{"source":"769888470198844466060018847331908530558873763","target":"1003658"},{"source":"769888470198844466060018847331908530558873763","target":"132179602421078339089658"},{"source":"769888470198844466060018847331908530558873763","target":"85785093551411052995361780846544060518131352208111836288890"},{"source":"769888470198844466060018847331908530558873763","target":"41587875"},{"source":"1003658","target":"41587875"},{"source":"205086215272400159040928900","target":"7258777541606685391153001709676512508332504447624439957332754004586017187"},{"source":"138015836477012538048578345382051","target":"205086215272400159040928900"},{"source":"138015836477012538048578345382051","target":"297334331408014797863880803692"},{"source":"688183928546371541082371129812436529315","target":"297334331408014797863880803692"},{"source":"323352844319592415464693835620702358430418676836371564591063739297002084055993596066","target":"394118713153500426474532463774188"},{"source":"23775038621120774401398070950256476818110844422636","target":"394118713153500426474532463774188"},{"source":"769888470198844466060018847331908530558873763","target":"394118713153500426474532463774188"},{"source":"297334331408014797863880803692","target":"688183928546371541082371129812436529315"}],"nodes":[{"id":"138015836477012538048578345382051","path":"/about-this-project","label":"About the Nature of Order"},{"id":"610601268545156228624720316487646442962654931095","path":"/alexander-and-religion","label":"Christopher Alexander and Religion"},{"id":"323352844319592415464693835620702358430418676836371564591063739297002084055993596066","path":"/always-look-one-level-above-and-below-your-current-level-of-scale","label":"Always look one level above and below your current level of scale"},{"id":"64028557324129785503","path":"/digital-garden","label":"Digital Garden"},{"id":"23775038621120774401398070950256476818110844422636","path":"/digital-gardening-is-a-living-process","label":"Digital gardening is a living process"},{"id":"100759890665887256092116","path":"/geometry-in-music","label":"Geometry in music"},{"id":"4701053458907636276591417210","path":"/geometry-in-software","label":"Geometry in software"},{"id":"102978783333107716768322","path":"/growing-this-site","label":"Growing this site"},{"id":"769888470198844466060018847331908530558873763","path":"/key-concepts","label":"Key concepts in The Nature of Order"},{"id":"1003658","path":"/life","label":"Life"},{"id":"132179602421078339089658","path":"/living-structure","label":"Living structure"},{"id":"1059864631337712197757777314496580482493980325847","path":"/loosing-the-sense-of-true-connection","label":"Loosing the sense of true connection"},{"id":"85785093551411052995361780846544060518131352208111836288890","path":"/mechanization-in-architecture-and-software","label":"Mechanization in architecture and software"},{"id":"30704","path":"/now","label":"Now"},{"id":"41587875","path":"/order","label":"Order"},{"id":"7258777541606685391153001709676512508332504447624439957332754004586017187","path":"/places-for-interaction","label":"Interactive places discussing Christopher Alexander"},{"id":"205086215272400159040928900","path":"/project-objectives","label":"Project Objectives"},{"id":"14357143319525786425398317879739388870016332133127969692276783298763118607746","path":"/shared-understanding-is-needed-to-have-meaningful-debate","label":"Shared understanding is needed to have meaningful debate"},{"id":"297334331408014797863880803692","path":"/structure-of-the-books","label":"Structure of the books"},{"id":"394118713153500426474532463774188","path":"/the-fundamental-process","label":"The fundamental process"},{"id":"688183928546371541082371129812436529315","path":"/unfolding-the-nature-of-order","label":"Unfolding the Nature of Order"}]}
    let nodesData = graphData.nodes;
    let linksData = graphData.edges;

    const nodeSize = {};

    const updateNodeSize = () => {
      nodesData.forEach((el) => {
        let weight =
          3 *
          Math.sqrt(
            linksData.filter((l) => l.source === el.id || l.target === el.id)
              .length + 1
          );
        if (weight < MINIMAL_NODE_SIZE) {
          weight = MINIMAL_NODE_SIZE;
        } else if (weight > MAX_NODE_SIZE) {
          weight = MAX_NODE_SIZE;
        }
        nodeSize[el.id] = weight;
      });
    };

    const onClick = (d) => {
      window.location = d.path
    };

    const onMouseover = function (d) {
      const relatedNodesSet = new Set();
      linksData
        .filter((n) => n.target.id == d.id || n.source.id == d.id)
        .forEach((n) => {
          relatedNodesSet.add(n.target.id);
          relatedNodesSet.add(n.source.id);
        });

      node.attr("class", (node_d) => {
        if (node_d.id !== d.id && !relatedNodesSet.has(node_d.id)) {
          return "inactive";
        }
        return "";
      });

      link.attr("class", (link_d) => {
        if (link_d.source.id !== d.id && link_d.target.id !== d.id) {
          return "inactive";
        }
        return "";
      });

      link.attr("stroke-width", (link_d) => {
        if (link_d.source.id === d.id || link_d.target.id === d.id) {
          return STROKE * 4;
        }
        return STROKE;
      });
      text.attr("class", (text_d) => {
        if (text_d.id !== d.id && !relatedNodesSet.has(text_d.id)) {
          return "inactive";
        }
        return "";
      });
    };

    const onMouseout = function (d) {
      node.attr("class", "");
      link.attr("class", "");
      text.attr("class", "");
      link.attr("stroke-width", STROKE);
    };

    const sameNodes = (previous, next) => {
      if (next.length !== previous.length) {
        return false;
      }

      const map = new Map();
      for (const node of previous) {
        map.set(node.id, node.label);
      }

      for (const node of next) {
        const found = map.get(node.id);
        if (!found || found !== node.title) {
          return false;
        }
      }

      return true;
    };

    const sameEdges = (previous, next) => {
      if (next.length !== previous.length) {
        return false;
      }

      const set = new Set();
      for (const edge of previous) {
        set.add(`${edge.source.id}-${edge.target.id}`);
      }

      for (const edge of next) {
        if (!set.has(`${edge.source}-${edge.target}`)) {
          return false;
        }
      }

      return true;
    };

    const graphWrapper = document.getElementById('graph-wrapper')
    const element = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    element.setAttribute("width", graphWrapper.getBoundingClientRect().width);
    element.setAttribute("height", window.innerHeight * 0.8);
    graphWrapper.appendChild(element);

    const reportWindowSize = () => {
      element.setAttribute("width", window.innerWidth);
      element.setAttribute("height", window.innerHeight);
    };

    window.onresize = reportWindowSize;

    const svg = d3.select("svg");
    const width = Number(svg.attr("width"));
    const height = Number(svg.attr("height"));
    let zoomLevel = 1;

    const simulation = d3
      .forceSimulation(nodesData)
      .force("forceX", d3.forceX().x(width / 2))
      .force("forceY", d3.forceY().y(height / 2))
      .force("charge", d3.forceManyBody())
      .force(
        "link",
        d3
          .forceLink(linksData)
          .id((d) => d.id)
          .distance(70)
      )
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collision", d3.forceCollide().radius(80))
      .stop();

    const g = svg.append("g");
    let link = g.append("g").attr("class", "links").selectAll(".link");
    let node = g.append("g").attr("class", "nodes").selectAll(".node");
    let text = g.append("g").attr("class", "text").selectAll(".text");

    const resize = () => {
      if (d3.event) {
        const scale = d3.event.transform;
        zoomLevel = scale.k;
        g.attr("transform", scale);
      }

      const zoomOrKeep = (value) => (zoomLevel >= 1 ? value / zoomLevel : value);

      const font = Math.max(Math.round(zoomOrKeep(FONT_SIZE)), 1);

      text.attr("font-size", (d) => font);
      text.attr("y", (d) => d.y - zoomOrKeep(FONT_BASELINE) + 8);
      link.attr("stroke-width", zoomOrKeep(STROKE));
      node.attr("r", (d) => {
        return zoomOrKeep(nodeSize[d.id]);
      });
      svg
        .selectAll("circle")
        .filter((_d, i, nodes) => d3.select(nodes[i]).attr("active"))
        .attr("r", (d) => zoomOrKeep(ACTIVE_RADIUS_FACTOR * nodeSize[d.id]));

      document.getElementById("zoom").innerHTML = zoomLevel.toFixed(2);
    };

    const ticked = () => {
      node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
      text
        .attr("x", (d) => d.x)
        .attr("y", (d) => d.y - (FONT_BASELINE - nodeSize[d.id]) / zoomLevel);
      link
        .attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);
    };

    const restart = () => {
      updateNodeSize();
      node = node.data(nodesData, (d) => d.id);
      node.exit().remove();
      node = node
        .enter()
        .append("circle")
        .attr("r", (d) => {
          return nodeSize[d.id];
        })
        .on("click", onClick)
        .on("mouseover", onMouseover)
        .on("mouseout", onMouseout)
        .merge(node);

      link = link.data(linksData, (d) => `${d.source.id}-${d.target.id}`);
      link.exit().remove();
      link = link.enter().append("line").attr("stroke-width", STROKE).merge(link);

      text = text.data(nodesData, (d) => d.label);
      text.exit().remove();
      text = text
        .enter()
        .append("text")
        .text((d) => shorten(d.label.replace(/_*/g, ""), MAX_LABEL_LENGTH))
        .attr("font-size", `${FONT_SIZE}px`)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "central")
        .on("click", onClick)
        .on("mouseover", onMouseover)
        .on("mouseout", onMouseout)
        .merge(text);

      node.attr("active", (d) => isCurrentPath(d.path) ? true : null);
      text.attr("active", (d) => isCurrentPath(d.path) ? true : null);

      simulation.nodes(nodesData);
      simulation.force("link").links(linksData);
      simulation.alpha(1).restart();
      simulation.stop();

      for (let i = 0; i < TICKS; i++) {
        simulation.tick();
      }

      ticked();
    };

    const zoomHandler = d3.zoom().scaleExtent([0.2, 3]).on("zoom", resize);

    zoomHandler(svg);
    restart();

    function isCurrentPath(notePath) {
      return window.location.pathname.includes(notePath)
    }

    function shorten(str, maxLen, separator = ' ') {
      if (str.length <= maxLen) return str;
      return str.substr(0, str.lastIndexOf(separator, maxLen)) + '...';
    }
  </script>
</div>
</main>
      <footer>Unfolding the Nature of Order :: <a class="internal-link" href="/about">About</a>
</footer>
    </div>

    <!-- That file is not particularly elegant. This will need a refactor at some point. -->
<style>
  content a.internal-link {
    border-color: #8b88e6;
    background-color: #efefff;
  }

  #tooltip-wrapper {
    background: white;
    padding: 1em;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
    position: absolute;
    width: 400px;
    height: 250px;
    font-size: 0.8em;
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    opacity: 0;
    transition: opacity 100ms;
  }

  #tooltip-wrapper:after {
		content: "";
		position: absolute;
		z-index: 1;
		bottom: 0;
		left: 0;
		pointer-events: none;
		background-image: linear-gradient(to bottom, rgba(255,255,255, 0), rgba(255,255,255, 1) 90%);
		width: 100%;
		height: 75px;
  }
</style>

<div style="opacity: 0; display: none;" id='tooltip-wrapper'>
  <div id='tooltip-content'>
  </div>
</div>

<iframe style="display: none; height: 0; width: 0;" id='link-preview-iframe' src="">
</iframe>

<script>
  var opacityTimeout;
  var contentTimeout;
  var transitionDurationMs = 100;

  var iframe = document.getElementById('link-preview-iframe')
  var tooltipWrapper = document.getElementById('tooltip-wrapper')
  var tooltipContent = document.getElementById('tooltip-content')

  function hideTooltip() {
    opacityTimeout = setTimeout(function() {
      tooltipWrapper.style.opacity = 0;
      contentTimeout = setTimeout(function() {
        tooltipContent.innerHTML = '';
        tooltipWrapper.style.display = 'none';
      }, transitionDurationMs + 1);
    }, transitionDurationMs)
  }

  function showTooltip(event) {
    var elem = event.target;
    var elem_props = elem.getClientRects()[elem.getClientRects().length - 1];
    var top = window.pageYOffset || document.documentElement.scrollTop

    if (event.target.host === window.location.host) {
      iframe.src = event.target.href
      iframe.onload = function() {
        tooltipContentHtml = ''
        tooltipContentHtml += '<div style="font-weight: bold;">' + iframe.contentWindow.document.querySelector('h1').innerHTML + '</div>'
        tooltipContentHtml += iframe.contentWindow.document.querySelector('content').innerHTML

        tooltipContent.innerHTML = tooltipContentHtml

        tooltipWrapper.style.display = 'block';
        setTimeout(function() {
          tooltipWrapper.style.opacity = 1;
        }, 1)
      }

      tooltipWrapper.style.left = elem_props.left - (tooltipWrapper.offsetWidth / 2) + (elem_props.width / 2) + "px";
      if ((window.innerHeight - elem_props.top) < (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top - tooltipWrapper.offsetHeight - 10 + "px";
      } else if ((window.innerHeight - elem_props.top) > (tooltipWrapper.offsetHeight)) {
          tooltipWrapper.style.top = elem_props.top + top + 35 + "px";
      }

      if ((elem_props.left + (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = "10px";
      } else if ((document.body.clientWidth - elem_props.left - (elem_props.width / 2)) < (tooltipWrapper.offsetWidth / 2)) {
          tooltipWrapper.style.left = document.body.clientWidth - tooltipWrapper.offsetWidth - 20 + "px";
      }
    }
  }

  function setupListeners(linkElement) {
    linkElement.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    tooltipWrapper.addEventListener('mouseleave', function(_event) {
      hideTooltip();
    });

    linkElement.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
      showTooltip(event);
    });

    tooltipWrapper.addEventListener('mouseenter', function(event) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
    });
  }

  document.querySelectorAll('content a').forEach(setupListeners);
</script>

  </body>
</html>
